SET search_path TO projet;


-- Sch√©ma

DROP SCHEMA IF EXISTS projet CASCADE;
CREATE SCHEMA projet AUTHORIZATION projet;
GRANT ALL PRIVILEGES ON SCHEMA projet TO projet;


-- Tables


CREATE TABLE categorie (
	IdCategorie		INT			 	NOT NULL	GENERATED BY DEFAULT AS IDENTITY,
	NomCat VARCHAR(80) NOT NULL,
	PRIMARY KEY (IdCategorie)

);
--CREATE UNIQUE INDEX idx_cat ON categorie (NomCat ASC);


CREATE TABLE auteur (
	IdAuteur	INT			 	NOT NULL	GENERATED BY DEFAULT AS IDENTITY,
	Nom VARCHAR(80) NOT NULL ,
	Prenom VARCHAR(80) NOT NULL ,
	--
	PRIMARY KEY (IdAuteur)

);

CREATE TABLE editeur (
	IdEditeur	INT			 	NOT NULL	GENERATED BY DEFAULT AS IDENTITY,
	Nom VARCHAR(80) NOT NULL ,
	Prenom VARCHAR(80) NOT NULL ,
	--
	PRIMARY KEY (IdEditeur)

);


CREATE TABLE compte (
	IdCompte		INT			 	NOT NULL	GENERATE BY DEFAULT AS IDENTITY,
	Pseudo			VARCHAR(25)		NOT NULL UNIQUE, --
	MotDePasse		VARCHAR(25) 	NOT NULL,
	Email			VARCHAR(100)	NOT NULL,
	--IdDocument	INT 	,
	--FOREIGN KEY (IdDocument) REFERENCES document (IdDocument),
	PRIMARY KEY (IdCompte)	
);
CREATE UNIQUE INDEX idx_compte_pseudo ON compte (Pseudo ASC);

CREATE TABLE role (
	IdCompte		INT				NOT NULL,
	Role			VARCHAR(20)		NOT NULL,
	CHECK( Role IN ('ADMINISTRATEUR','UTILISATEUR') ),	
	FOREIGN KEY (IdCompte) REFERENCES compte (IdCompte),
	PRIMARY KEY (IdCompte, Role)
);


CREATE TABLE demande (
		IdDemande	INT			 	NOT NULL	GENERATED BY DEFAULT AS IDENTITY,
		IdCompteSender		INT		NOT NULL,
		IdCompteReceiver	INT		NOT NULL,
		Statut VARCHAR(50) NOT NULL,
		FOREIGN KEY (IdCompteSender) REFERENCES compte (IdCompte),
		CHECK( Statut IN ('A','R','H') ),	
		PRIMARY KEY (IdDemande,IdCompteSender) --
);

--
CREATE TABLE document (
	IdDocument	INT			 	NOT NULL	GENERATED BY DEFAULT AS IDENTITY,
	IdCategorie		INT	NOT NULL,
	IdAuteur INT NOT NULL,
	IdEditeur INT NOT NULL,
	IdCompte		INT	NOT NULL	,
	NomDoc VARCHAR(400) NOT NULL ,
	Disponible BOOLEAN NOT NULL ,	
	CHECK( Disponible IN ('Y','N') ),	
	FOREIGN KEY (IdCompte) REFERENCES compte (IdCompte),	
	FOREIGN KEY (IdCategorie) REFERENCES categorie (IdCategorie),
	FOREIGN KEY (IdEditeur) REFERENCES editeur (IdEditeur),
	FOREIGN KEY (IdAuteur) REFERENCES auteur (IdAuteur),
	PRIMARY KEY (IdDocument)
);


CREATE TABLE emprunt (
		IdEmprunt	INT			 	NOT NULL	GENERATED BY DEFAULT AS IDENTITY,
		IdCompte		INT		NOT NULL,	
		IdDocument	INT		NOT NULL,
		Statut VARCHAR(50) NOT NULL,
		FOREIGN KEY (IdCompte) REFERENCES compte (IdCompte),
		FOREIGN KEY (IdDocument) REFERENCES document (IdDocument),
		CHECK( Statut IN ('A','R','H','T') ),	--/!\
		PRIMARY KEY (IdEmprunt,IdDocument,IdCompte) --
);

